{% extends 'base.html' %}
{% block content %}
{% include '_menu_burger.html' %}


<style>
.color-palette {
  display: flex;
  gap: 4px;
  margin-top: 4px;
}
.color-swatch {
  width: 20px; height: 20px;
  border: 1px solid #ccc;
  cursor: pointer;
}
</style>

<div class="container py-4">
  <div class="row">
    <div class="col-md-9">
      <h4 class="mb-3">Programmation du clavier : {{ clavier.nom if clavier else 'Aucun clavier s√©lectionn√©' }}</h4>
      <div id="clavier-container" class="d-flex flex-wrap" style="width: 624px; height: 715px;"></div>
      {% if message %}
        <div class="position-fixed top-0 end-0 p-3" style="z-index: 1055">
          <div id="toastMessage" class="toast align-items-center text-white bg-{{ message_type or 'success' }} border-0 show" role="alert">
            <div class="d-flex">
              <div class="toast-body">
                {{ message }}
              </div>
              <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Fermer"></button>
            </div>
          </div>
        </div>
      {% endif %}
    </div>

    <div class="col-md-3">
      <div class="card mb-3">
        <div class="card-header">Cr√©er un clavier</div>
        <div class="card-body">
          <form method="post" action="{{ url_for('creer_clavier') }}">
            <input type="text" name="nom" class="form-control mb-2" placeholder="Nom du clavier" required>
            <button type="submit" class="btn btn-primary btn-sm w-100">Cr√©er</button>
          </form>
        </div>
      </div>

      <div class="card mb-3">
        <div class="card-header">Claviers disponibles</div>
        <div class="card-body">
          <form method="get" action="{{ url_for('programmation.programmation_claviers') }}">
            <div class="mb-3" style="max-height: 250px; overflow-y: auto;">
              <ul class="list-group">
                {% for c in claviers %}
                  <li class="list-group-item d-flex justify-content-between align-items-center {% if c.id == clavier.id %}active{% endif %}">
                    <a href="{{ url_for('clavier_bp.programmation_claviers', clavier_id=c.id) }}"
                       class="{% if c.id == clavier.id %}text-white{% else %}text-dark{% endif %} text-decoration-none">
                      {{ c.nom }}
                    </a>
                    <form method="post"
                          action="{{ url_for('clavier_bp.supprimer_clavier', id=c.id) }}"
                          onsubmit="return confirm('Confirmer la suppression ?');"
                          style="margin: 0;">
                      <button type="submit" class="btn btn-sm btn-danger">üóëÔ∏è</button>
                    </form>
                  </li>
                {% endfor %}
              </ul>
            </div>
          </form>
          {% if clavier %}
          <a href="#" onclick="confirmReset({{ clavier.id }})" class="btn btn-warning btn-sm w-100 mb-2">R√©initialiser</a>
          <a href="{{ url_for('dupliquer_clavier', id=clavier.id) }}" class="btn btn-secondary btn-sm w-100 mb-2">Dupliquer</a>
          <form method="post" action="{{ url_for('clavier_bp.import_clavier', id=clavier.id) }}" enctype="multipart/form-data">
            <input type="file" name="file" class="form-control form-control-sm mb-2" accept=".json">
            <button type="submit" class="btn btn-info btn-sm w-100">Importer</button>
          </form>
          <a href="{{ url_for('programmation.export_clavier', id=clavier.id) }}" class="btn btn-success btn-sm w-100">Exporter</a>
          {% endif %}
        </div>
      </div>

      {% if clavier %}
      <div class="card mb-3">
        <div class="card-header">Effacer bouton / ligne</div>
        <div class="card-body">
          <form class="mb-2" method="post" action="/clavier/effacer_bouton/?clavier_id={{ clavier.id }}">
            <div class="input-group">
              <span class="input-group-text">Pos</span>
              <input type="number" name="effacerPosition" min="1" max="55" class="form-control" placeholder="1-55">
              <button type="submit" class="btn btn-danger">‚ùå</button>
            </div>
          </form>
          <form method="post" action="/clavier/effacer_ligne/?clavier_id={{ clavier.id }}">
            <div class="input-group">
              <span class="input-group-text">Ligne</span>
              <input type="number" name="effacerLigne" min="1" max="11" class="form-control" placeholder="1-11">
              <button type="submit" class="btn btn-danger">üßπ</button>
            </div>
          </form>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Modale configuration bouton -->
<div class="modal fade" id="buttonModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Configurer le bouton</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="buttonForm">
          <input type="hidden" name="position" id="positionInput">
          <input type="hidden" name="clavier_id" id="clavierIdInput" value="{{ clavier.id if clavier else '' }}">
          <div class="mb-2">
            <label for="typeInput">Type</label>
            <select name="type" id="typeInput" class="form-select">
              <option value="article">Article</option>
              <option value="clavier">Clavier</option>
              <option value="reglement">R√®glement</option>
              <option value="utilisateur">Utilisateur</option>
              <option value="fonction">Fonction</option>
              <option value="menu">Menu</option>
              <option value="formule">Formule</option>
              <option value="commentaire">Commentaire</option>
            </select>
          </div>
          <div class="mb-2">
            <label for="elementInput">√âl√©ment</label>
            <select name="element_id" id="elementInput" class="form-select"></select>
          </div>
          <div class="mb-2">
            <!-- Couleur de fond existante -->
            <label for="bg-color-picker">Couleur de fond :</label>
            <input type="color" id="bg-color-picker" name="couleur" value="#e0e0e0">

            <!-- NOUVEAU : Couleur du texte -->
            <label for="text-color-picker">Couleur du texte :</label>
            <input type="color" id="text-color-picker" name="text_color" value="#000000">

              <div>
              <p>Derni√®res couleurs de fond :</p>
              <div id="recent-bg-colors" class="color-palette"></div>
            </div>
            <div>
              <p>Derni√®res couleurs de texte :</p>
              <div id="recent-text-colors" class="color-palette"></div>
            </div>
          </div>
          <div class="mb-2">
            <label for="imageInput">Image (facultatif)</label>
            <input type="text" name="image" id="imageInput" class="form-control">
          </div>
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="masquerTexteInput" name="masquer_texte">
            <label class="form-check-label" for="masquerTexteInput">Masquer le texte</label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-primary" onclick="saveButtonConfig()">Enregistrer</button>
      </div>
    </div>
  </div>
</div>

<script>
function openButtonModal(pos, bouton) {
  // r√©cup√®re les inputs
  const positionInput   = document.getElementById('positionInput');
  const typeInput       = document.getElementById('typeInput');
  const elementInput    = document.getElementById('elementInput');
  const bgPicker        = document.getElementById('bg-color-picker');
  const textPicker      = document.getElementById('text-color-picker');
  const imageInput      = document.getElementById('imageInput');
  const masquerInput    = document.getElementById('masquerTexteInput');

  // D√©finit les valeurs fixes
  positionInput.value  = pos;
  typeInput.value      = bouton.type          || 'article';
  imageInput.value     = bouton.image         || '';
  masquerInput.checked = bouton.masquer_texte || false;

  // **Le plus important** : on log et on assigne text_color
  console.log('üñçÔ∏è Couleur texte du bouton #', pos, ' =', bouton.text_color);
  bgPicker.value   = bouton.couleur    || '#e0e0e0';
  textPicker.value = bouton.text_color || '#000000';

  // charge la liste d√©roulante selon le type s√©lectionn√©
  fetch(`/clavier/elements?type=${typeInput.value}`)
    .then(r => r.json())
    .then(data => {
      elementInput.innerHTML = '';
      data.forEach(e => {
        const opt = document.createElement('option');
        opt.value = e.id;
        opt.text  = e.nom;
        if (e.id == bouton.element_id) opt.selected = true;
        elementInput.appendChild(opt);
      });
    })
    .catch(err => {
      console.error('Erreur lors du chargement des √©l√©ments :', err);
      alert("Erreur lors du chargement des √©l√©ments.");
    });

  // √† chaque changement de type, on recharge aussi
  typeInput.onchange = () => openButtonModal(pos, bouton);

  // enfin, on affiche la modale
  new bootstrap.Modal(document.getElementById('buttonModal')).show();
}

function saveButtonConfig() {
  const bgColor   = document.getElementById('bg-color-picker').value;
  const textColor = document.getElementById('text-color-picker').value;
  const form = document.getElementById('buttonForm');
  const data = Object.fromEntries(new FormData(form).entries());
  data.masquer_texte = document.getElementById('masquerTexteInput').checked;

  fetch('/clavier/save_bouton', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  })
  .then(res => res.json())
  .then(resp => {
      console.log('‚á® boutons JSON:', data);
    if (resp.status === 'ok') {
      window.location.reload();
    } else {
      alert("Erreur lors de l'enregistrement");
    }
  })
  .catch(err => {
    console.error('Erreur lors de la sauvegarde :', err);
    alert("Une erreur est survenue");
  });
}

// chargement dynamique des boutons sur grille
window.addEventListener('DOMContentLoaded', () => {
  const clavierId = {{ clavier.id if clavier else 0 }};
  const container = document.getElementById('clavier-container');

  fetch(`/clavier/boutons/${clavierId}`)
  .then(res => res.json())
  .then(data => {
    container.innerHTML = '';
    for (let row = 0; row < 11; row++) {
      const rowDiv = document.createElement('div');
      rowDiv.className = 'd-flex';
      rowDiv.style.width = '100%';

      for (let col = 0; col < 5; col++) {
        const pos = row * 5 + col + 1;
        const b = data.find(btn => btn.position === pos) || {};

        const btn = document.createElement('button');
        btn.className = 'btn me-1 mb-1';
        btn.style.width  = '124px';
        btn.style.height = '65px';

        // Fond et texte
        btn.style.backgroundColor = b.couleur || '#e0e0e0';
        if (b.text_color) {
          btn.style.color = b.text_color;
        }

        btn.onclick = () => openButtonModal(pos, b);

        if (b.image) {
          const img = document.createElement('img');
          img.src    = `/static/${b.image}`;
          img.alt    = '';
          img.style.width  = '100%';
          img.style.height = '100%';
          btn.appendChild(img);
        } else {
          btn.textContent = b.nom || `Vide ${pos}`;
        }

        rowDiv.appendChild(btn);
      }
      container.appendChild(rowDiv);
    }
  })
    .catch(err => {
      console.error("Erreur lors du chargement des boutons :", err);
      container.innerHTML = '<p class="text-danger">Erreur de chargement des boutons.</p>';
    });
});
function confirmReset(clavierId) {
  if (confirm('‚ö†Ô∏è Voulez-vous vraiment r√©initialiser ce clavier ? Cette action supprimera tous les boutons.')) {
    window.location.href = `/clavier/reset?clavier_id=${clavierId}`;
  }
}

window.addEventListener('DOMContentLoaded', () => {
    const toastEl = document.getElementById('toastMessage');
    if (toastEl) {
      const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
      toast.show();
    }
  });

</script>

<script>
// 1) Cl√©s pour stocker dans localStorage
const BG_KEY = 'programmation_recent_bg';
const TXT_KEY = 'programmation_recent_text';
const MAX_SWATCHES = 8;

// 2) Helpers pour lire/√©crire un tableau de couleurs
function loadRecent(key) {
  try {
    return JSON.parse(localStorage.getItem(key)) || [];
  } catch {
    return [];
  }
}
function saveRecent(key, arr) {
  localStorage.setItem(key, JSON.stringify(arr.slice(0, MAX_SWATCHES)));
}

// 3) Mettre √† jour les swatches d‚Äôun type (bg ou text)
function renderPalette(key, containerId, pickerId) {
  const arr = loadRecent(key);
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  arr.forEach(color => {
    const sw = document.createElement('div');
    sw.className = 'color-swatch';
    sw.style.background = color;
    sw.addEventListener('click', () => {
      document.getElementById(pickerId).value = color;
    });
    container.appendChild(sw);
  });
}

// 4) Au changement d‚Äôun picker, on m√©morise et on r√©affiche
function hookPicker(pickerId, key, containerId) {
  const picker = document.getElementById(pickerId);
  picker.addEventListener('input', () => {
    let arr = loadRecent(key);
    // place la nouvelle couleur en premi√®re position
    arr = [picker.value, ...arr.filter(c => c !== picker.value)];
    saveRecent(key, arr);
    renderPalette(key, containerId, pickerId);
  });
}

// 5) Initialisation au chargement
document.addEventListener('DOMContentLoaded', () => {
  // Affiche palettes existantes
  renderPalette(BG_KEY, 'recent-bg-colors', 'bg-color-picker');
  renderPalette(TXT_KEY, 'recent-text-colors', 'text-color-picker');

  // Branche les pickers pour m√©moriser les choix
  hookPicker('bg-color-picker', BG_KEY, 'recent-bg-colors');
  hookPicker('text-color-picker', TXT_KEY, 'recent-text-colors');
});
</script>

{% endblock %}
